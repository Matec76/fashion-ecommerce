<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>STYLEX | Quản lý Khách hàng</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        /* Giữ nguyên phần CSS của anh */
        .page-breadcrumb { font-size: 14px; color: #7f8c8d; margin-bottom: 10px; }
        .topbar h2 { font-size: 28px; font-weight: 700; color: #0f1b2c; margin: 0; }
        .dashboard-body { padding: 40px; background-color: #fff; }
        .content-header { display: flex; justify-content: space-between; margin-bottom: 20px; }
        .btn-black { background-color: #1e293b; color: white; padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .btn-black:hover { background-color: #0f1b2c; }
        .data-table { width: 100%; border-collapse: collapse; }
        .data-table th { text-align: left; padding: 15px; border-bottom: 2px solid #eee; color: #666; font-size: 13px; text-transform: uppercase; }
        .data-table td { padding: 15px; border-bottom: 1px solid #eee; vertical-align: middle; }
        .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
        .modal-content { background-color: #fefefe; margin: 5% auto; padding: 30px; border-radius: 12px; width: 450px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; font-size: 13px; color: #64748b; text-transform: uppercase; }
        .form-group input { width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; box-sizing: border-box; }
        .modal-actions { display: flex; justify-content: flex-end; gap: 10px; margin-top: 30px; }
        .btn-cancel { background: #f1f5f9; color: #64748b; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; }
    </style>
</head>
<body>
    <aside class="sidebar">
        <div class="logo"><h1>STYLEX</h1></div>
        <nav class="main-menu">
            <ul>
                <li><a href="{{ url_for('auth.tongquan') }}"><span class="material-symbols-outlined">home</span> Tổng quan</a></li>
                <li><a href="{{ url_for('sanpham.index') }}"><span class="material-symbols-outlined">inventory_2</span> Sản phẩm</a></li>
                <li><a href="{{ url_for('donhang.index') }}"><span class="material-symbols-outlined">receipt_long</span> Đơn hàng</a></li>
                <li class="active"><a href="{{ url_for('khachhang.index') }}"><span class="material-symbols-outlined">group</span> Khách hàng</a></li>
                <li><a href="{{ url_for('khac.marketing') }}"><span class="material-symbols-outlined">campaign</span> Marketing</a></li>
                <li><a href="{{ url_for('khac.noidung') }}"><span class="material-symbols-outlined">article</span> Nội dung</a></li>
                <li><a href="{{ url_for('khac.baocao') }}"><span class="material-symbols-outlined">bar_chart</span> Báo cáo</a></li>
                <li><a href="{{ url_for('khac.phanquyen') }}"><span class="material-symbols-outlined">settings</span> Cấu hình</a></li>
            </ul>
        </nav>
    </aside>

    <main class="content-area" style="background-color: #fff;">
        <div style="padding: 20px 40px 0 40px;">
            <div class="page-breadcrumb">Quản lý</div>
            <header class="topbar"><h2>Danh sách khách hàng</h2></header>
        </div>

        <div class="dashboard-body">
            <div class="content-header">
                <input type="text" placeholder="Tìm kiếm khách hàng..." style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; width: 300px;">
                <button id="btnAddCustomer" class="btn-black">Thêm khách hàng mới</button>
            </div>

            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Họ và tên</th>
                            <th>Email</th>
                            <th>Số điện thoại</th>
                            <th>Ngày đăng ký</th>
                            <th>Tổng chi tiêu</th>
                            <th>Hành động</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for k in customers %}
                        <tr>
                            <td style="font-weight: bold;">{{ k.ten }}</td>
                            <td>{{ k.email }}</td>
                            <td>{{ k.sdt }}</td>
                            <td>{{ k.ngay_dk }}</td>
                            <td style="color: #27ae60; font-weight: bold;">{{ k.tong_chi_tieu | format_money }}</td>
                            <td>
                                <a href="#" class="btn-delete" 
                                   data-name="{{ k.ten }}" 
                                   data-url="{{ url_for('khachhang.xoa', id_kh=k.id) }}" 
                                   style="color: #e74c3c; text-decoration: none; font-weight: 600;">Xóa</a>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="customerModal" class="modal">
        <div class="modal-content">
            <h3 style="margin-top:0;">Thêm khách hàng mới</h3>
            <form id="createCustomerForm" method="POST" action="{{ url_for('khachhang.them') }}">
                <div class="form-group">
                    <label>Họ và tên</label>
                    <input type="text" name="ten" required>
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" name="email">
                </div>
                <div class="form-group">
                    <label>Số điện thoại</label>
                    <input type="text" name="sdt" required>
                </div>
                <div class="form-group">
                    <label>Ngày đăng ký</label>
                    <input type="date" name="ngay_dk" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" id="btnCloseModal">Hủy</button>
                    <button type="submit" class="btn-black">Lưu lại</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const modal = document.getElementById('customerModal');
        const btnAdd = document.getElementById('btnAddCustomer');
        const btnClose = document.getElementById('btnCloseModal');

        if(btnAdd) btnAdd.onclick = () => modal.style.display = 'block';
        if(btnClose) btnClose.onclick = () => modal.style.display = 'none';
        window.onclick = (e) => { if(e.target == modal) modal.style.display = 'none'; }
        
        // SweetAlert xóa (Đã sửa để nhận URL từ Blueprint)
        document.querySelectorAll('.btn-delete').forEach(btn => {
            btn.onclick = (e) => {
                e.preventDefault();
                const url = btn.getAttribute('data-url');
                const name = btn.getAttribute('data-name');
                Swal.fire({
                    title: `Xóa khách hàng ${name}?`,
                    text: 'Dữ liệu khách hàng sẽ bị xóa vĩnh viễn và không thể hoàn tác!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'Xác nhận xóa',
                    cancelButtonText: 'Hủy',
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#94a3b8'
                }).then(res => { 
                    if(res.isConfirmed) {
                        window.location.href = url;
                    }
                });
            }
        });
    </script>
</body>
</html>